{% extends "base.html" %}

{% block content %}
  <div class="page">
    <h1>Your Cart</h1>
    <p>Review the medicines in your cart before proceeding to checkout.</p>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for item in cart_items %}
          <tr id="item-{{ item.medicine_id }}">
            <td>{{ item.name }}</td>
            <td class="price" data-price="{{ item.price }}">৳{{ '%.2f'|format(item.price) }}</td>
            <td>
              <button class="quantity-btn" onclick="changeQuantity({{ item.medicine_id }}, -1)">-</button>
              <span id="quantity-{{ item.medicine_id }}">{{ item.quantity }}</span>
              <button class="quantity-btn" onclick="changeQuantity({{ item.medicine_id }}, 1)">+</button>
            </td>
            <td id="total-{{ item.medicine_id }}">৳{{ '%.2f'|format(item.price * item.quantity) }}</td>
            <td><button class="btn" onclick="removeItem({{ item.medicine_id }})">Remove</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="cart-total">
      <h3>Total: ৳<span id="total-amount">{{ total_amount | round(2) }}</span></h3>
      <a href="{{ url_for('shop.payment_page') }}" class="btn">Proceed to Checkout</a>
    </div>
  </div>

  <script>
    // Function to change the quantity of an item
    function changeQuantity(medicineId, change) {
      const quantityElement = document.getElementById("quantity-" + medicineId);
      const currentQuantity = parseInt(quantityElement.textContent);

      let newQuantity = currentQuantity + change;
      if (newQuantity < 1) return;  // Prevent quantity from going below 1

      // Get the price from the data attribute
      const priceCell = document.querySelector(`#item-${medicineId} .price`);
      const price = parseFloat(priceCell.getAttribute('data-price'));
      
      // Calculate the new total for this item
      const newItemTotal = price * newQuantity;
      
      // Update the quantity and total displayed on the page
      quantityElement.textContent = newQuantity;
      document.getElementById("total-" + medicineId).textContent = "৳" + newItemTotal.toFixed(2);

      // Recalculate the entire cart total
      recalculateTotal();

      // Send AJAX request to update the cart in the database
      fetch(`/cart/update/${medicineId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          quantity: newQuantity
        })
      })
      .then(response => response.json())
      .then(data => {
        if (!data.ok) {
          alert("Failed to update cart.");
          // Reload the page to sync with server data
          location.reload();
        }
      })
      .catch(error => {
        console.error("Error:", error);
        alert("Failed to update cart.");
        location.reload();
      });
    }

    // Function to recalculate the entire cart total
    function recalculateTotal() {
      let total = 0;
      const itemTotalElements = document.querySelectorAll('[id^="total-"]');
      
      itemTotalElements.forEach(element => {
        // Skip the main total-amount element
        if (element.id === 'total-amount') return;
        
        const totalText = element.textContent.replace('৳', '');
        total += parseFloat(totalText);
      });
      
      document.getElementById("total-amount").textContent = total.toFixed(2);
    }

    // Remove an item from the cart
    function removeItem(medicineId) {
      if (!confirm("Are you sure you want to remove this item from your cart?")) {
        return;
      }

      fetch(`/cart/remove/${medicineId}`, {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          // Remove the row from the table
          const row = document.getElementById("item-" + medicineId);
          row.remove();
          
          // Recalculate the total after removal
          recalculateTotal();
        } else {
          alert("Failed to remove item.");
        }
      })
      .catch(error => {
        console.error("Error:", error);
        alert("Failed to remove item.");
      });
    }
  </script>
{% endblock %}